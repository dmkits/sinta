<!DOCTYPE html>
<html lang="ru">
<!--xmlns="http://www.w3.org/1999/xhtml"-->
<head>
    <link rel="shortcut icon" type="image/x-icon" href="/icons/heart16.ico"/>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
    <!--<meta name="apple-mobile-web-app-capable" content="yes"/>-->

    <link href="/jslib/dojox/mobile/themes/iphone/iphone.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/jslib/dojox/widget/Calendar/Calendar.css">
    <link rel="stylesheet" href="/jslib/dojox/calendar/themes/claro/Calendar.css">
    <link href="/jslib/dijit/themes/claro/claro.css" rel="stylesheet" type="text/css">
    <!--<script type="text/javascript" src="/jslib/dojox/mobile/deviceTheme.js"></script>-->
    <script src="/jslib/myutils.js"></script>
    <script src="/jslib/mainutils.js"></script>
    <script src="/jslib/handsontable/moment/moment-with-locales.js"></script>
    <script src="/jslib/handsontable/numeral/numeral.js"></script>
    <script src="/jslib/handsontable/numeral/languages/ru-UA.js"></script>
    <script type="text/javascript" src="/jslib/dojo/dojo.js"
            data-dojo-config="async: true, parseOnLoad: false"></script>
    <!--<script src="/jslib/dijit/dijit.js"></script>-->

    <title></title>
    <style>
        .claro table.dijitCalendarContainer {
            margin: 25px auto;
        }

        .mblTooltipBubble {
            overflow: visible;
            padding: 3px;
        . mblTooltipBubble-styles;
        }

        #date_picker {
            text-align: center;
            position: relative;
            font-size: 1.5em;
            font-weight: lighter;
        }

        #view_main_detail_btn {
            display: inline-block;
            position: relative;
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
            /*margin: 6px;*/
            /*padding: 0 10px;*/
            padding-bottom: 10px;
            margin-bottom: 5px;
            height: 29px;
            line-height: 29px;
            text-align: center;
            font-family: Helvetica;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 1);
            font-size: 13px;
            font-weight: bold;
            vertical-align: middle;

            border-width: 1px;
            border-style: solid;
            border-color: #2f3740 #405a7e #375073 #3a4755;
            -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.305);
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.305);

            color: #ffffff;
            background-color: #5877a2;
            background-image: -webkit-gradient(linear, left top, left bottom, from(#222222), to(#4a6c9b), color-stop(0.02, #8ea4c1), color-stop(0.5, #5877a2), color-stop(0.5, #476999));
            background-image: linear-gradient(to bottom, #222222 0%, #8ea4c1 2%, #5877a2 50%, #476999 50%, #4a6c9b 100%);
        }
    </style>
</head>
<body id="body" class="claro" style="width:100%; height: 100%">
</body>
<script>
    require(["dojo/dom-construct", "dojo/_base/xhr", "dojox/mobile", "dojox/mobile/parser", "dojox/mobile/View", "dojox/mobile/Heading", "dojox/mobile/RoundRectList",
                "dojox/mobile/ListItem", "dojo/parser", "dojo/ready", "dojox/mobile/ToolBarButton",
                "dijit/registry", "dojox/mobile/Tooltip", "dijit/CalendarLite", "dojox/mobile/IconItem", "dojox/mobile/IconContainer",
                "dojox/mobile/ToggleButton", "dojox/mobile/ScrollableView", "dojox/mobile/ProgressIndicator", "dojox/mobile/SimpleDialog", "dojox/mobile/Button"],

            function ( domConstruct, xhr, mobile, mparser, View, Heading, roundRectList, ListItem, parser, ready, ToolBarButton, registry,
                      Tooltip, CalendarLite, IconItem, IconContainer, ToggleButton, ScrollableView, ProgressIndicator, SimpleDialog, Button) {
                moment.locale("uk");
                numeral.language('ru-UA');

                var view_main = new View({id: "view_main"});
                document.getElementById('body').appendChild(view_main.domNode);
                view_main.inner_scroll = new ScrollableView({});
                document.getElementById('body').appendChild(view_main.inner_scroll.domNode);
                view_main.top_heading_main = new Heading({id:"th_main"});
                view_main.addChild(view_main.top_heading_main, 0);
                var pickUnitBtnHeading = new Heading({id:"pubtn_h"});
                var icon_btn = new ToolBarButton({
                    preventTouch: true,
                    clickable: false,
                    icon: "/icons/hearts29x29.ico",
                    iconPos: "0,0,29,29"
                });
                if (!view_main.dialogWin) {
                    view_main.dialogWin = new SimpleDialog({
                        id: "dialogWin"
                    });
                    document.getElementById('body').appendChild(view_main.dialogWin.domNode);
                }
                if (!view_main.msgBox) {
                    view_main.msgBox = domConstruct.create("div",
                            {class: "mblSimpleDialogText"},
                            view_main.dialogWin.domNode);
                }
                if (!view_main.cancelBtn)
                    view_main.cancelBtn = new Button({
                        class: "mblSimpleDialogButton mblRedButton",
                        innerHTML: "Ok"
                    });
                view_main.cancelBtn.connect(view_main.cancelBtn.domNode, "click",
                        function (e) {
                            view_main.dialogWin.hide()
                        });
                view_main.cancelBtn.placeAt(view_main.dialogWin.domNode);
                pickUnitBtnHeading.addChild(icon_btn);
                view_main.addChild(pickUnitBtnHeading);
                view_main.addChild(view_main.inner_scroll);
                var v = window.innerWidth - 90;
                view_main.pickUnitBtn = new ToolBarButton({
                    style: "width:" + v + "px; font-size:14px; align: center",
                    transition: "none",
                    moveTo: "pick_unit_view",
                    onClick: function () {
                        showPickUnitView(this, view_main)
                    }
                });
                window.onresize = function () {
                    v = window.innerWidth - 90;
                    view_main.pickUnitBtn.set("style", "width:" + v + "px; font-size:14px; align: center");
                };
                pickUnitBtnHeading.addChild(view_main.pickUnitBtn);
                view_main.setTopButtonsFor = function (view) {
                    if (!view.dateBtnHeading) {
                        var dateBtnHeading = new Heading({
                            fixed: "top"});
                        dateBtnHeading.startup();
                        view.dateBtnHeading = dateBtnHeading;
                        view.inner_scroll.domNode.appendChild(view.dateBtnHeading.domNode);
                    }
                    if (!view.btnBeginDate) {
                        view.btnBeginDate = new ToolBarButton({
                            moveTo: "calendar_view", id: "date_first_" + view.id,
                            transition: "none",
                            onClick: function () {
                                showCalendarView(this, "Начальная дата", view)
                            }
                        });
                        view.dateBtnHeading.addChild(view.btnBeginDate);
                        view.btnBeginDate.set("label", view_main.btnBeginDate.label);
                        view.btnBeginDate_dateValue = view_main.btnBeginDate_dateValue;
                    } else {
                        view.btnBeginDate.set("label", view_main.btnBeginDate.label);
                        view.btnBeginDate_dateValue = view_main.btnBeginDate_dateValue;
                    }
                    if (!view.btnEndDate) {
                        view.btnEndDate = new ToolBarButton({
                            moveTo: "calendar_view", id: "date_last_" + view.id,
                            transition: "none",
                            onClick: function () {
                                showCalendarView(this, "Конечная дата", view)
                            }
                        });
                        view.dateBtnHeading.addChild(view.btnEndDate);
                        view.btnEndDate.set("label", view_main.btnEndDate.label);
                        view.btnEndDate_dateValue = view_main.btnEndDate_dateValue;
                    } else {
                        view.btnEndDate.set("label", view_main.btnEndDate.label);
                        view.btnEndDate_dateValue = view_main.btnEndDate_dateValue;
                    }
                    if (!view_main.detailBtn) {
                        view_main.detailBtn = new ToggleButton({
                            label: "Детально",
                            id: view_main.id + "_detail_btn",
                            onClick: function () {
                                view_main.loadDetailContent()
                            }
                        });
                        view_main.dateBtnHeading.addChild(view_main.detailBtn);
                    }
                };

                view_main.setBottomButtonsFor = function (view) {
                    var tr = registry.byId(view.id + "hfbh");
                    var bottomHeading = registry.byId(view.id + "hf");
                    if (!bottomHeading) {
                        bottomHeading = new Heading({fixed: "bottom"}, view.id + "hf");
                        document.getElementById('body').appendChild(bottomHeading.domNode);

                        view.inner_scroll.domNode.appendChild(bottomHeading.domNode);
                        bottomHeading.startup();
                    }
                    if (!tr) {
                        var table = document.createElement('table');
                        table.setAttribute("align", "center");
                        var tbody = document.createElement('tbody');
                        var tr = document.createElement('tr');
                        var td = document.createElement('td');
                        td.setAttribute("aling", "center");
                        bottomHeading.domNode.appendChild(table);
                        table.appendChild(tbody);
                        tbody.appendChild(tr);
                        tr.appendChild(td);
                    }
                    if (!view.todayBtn) {
                        var bottom_btn1 = new ToolBarButton({
                            style: "padding-left:4px;padding-right:4px; ",
                            label: "Сегодня",
                            clickable: "true"
                        });
                        bottom_btn1.onClick = function () {
                            var today_beginning = moment().startOf('day');
                            var today_current_time = moment();
                            view.btnBeginDate_dateValue = today_beginning;
                            view.btnEndDate_dateValue = today_current_time;
                            view.btnBeginDate.set("label", today_beginning.format("DD.MM.YYYY"));
                            view.btnEndDate.set("label", today_current_time.format("DD.MM.YYYY"));
                            view.loadDetailContent();
                        };
                        view.todayBtn = bottom_btn1;
                        tr.appendChild(view.todayBtn.domNode);
                        view.todayBtn.startup();
                    }
                    if (!view.yesterdayBtn) {
                        var bottom_btn2 = new ToolBarButton({
                            style: "padding-left:4px;padding-right:4px; ",
                            label: "Вчера",
                            clickable: "true"
                        });
                        bottom_btn2.onClick = function () {
                            var yesterday_beginning = moment().startOf('day').subtract(1, 'days');
                            var yesterday_end = moment().endOf('day').subtract(1, 'days');
                            view.btnBeginDate_dateValue = yesterday_beginning;
                            view.btnEndDate_dateValue = yesterday_end;
                            view.btnBeginDate.set("label", yesterday_beginning.format("DD.MM.YYYY"));
                            view.btnEndDate.set("label", yesterday_end.format("DD.MM.YYYY"));
                            view.loadDetailContent();
                        };
                        view.yesterdayBtn = bottom_btn2;
                        tr.appendChild(view.yesterdayBtn.domNode);
                        view.yesterdayBtn.startup();
                    }
                    if (!view.weekBtn) {
                        var bottom_btn3 = new ToolBarButton({
                            style: "padding-left:4px;padding-right:4px; ",
                            label: "Неделя", clickable: "true"
                        });
                        bottom_btn3.onClick = function () {
                            var week_beginning = moment().startOf('week');
                            var today_current_time = moment();
                            view.btnBeginDate_dateValue = week_beginning;
                            view.btnEndDate_dateValue = today_current_time;
                            view.btnBeginDate.set("label", week_beginning.format("DD.MM.YYYY"));
                            view.btnEndDate.set("label", today_current_time.format("DD.MM.YYYY"));
                            view.loadDetailContent();
                        };
                        view.weekBtn = bottom_btn3;
                        tr.appendChild(view.weekBtn.domNode);
                        view.weekBtn.startup();
                    }
                    if (!view.monthBtn) {
                        var bottom_btn4 = new ToolBarButton({
                            style: "padding-left:4px;padding-right:4px; ",
                            label: "Месяц",
                            clickable: "true"
                        });
                        bottom_btn4.onClick = function () {
                            var month_beginning = moment().startOf('month');
                            var today_current_time = moment();
                            view.btnBeginDate_dateValue = month_beginning;
                            view.btnEndDate_dateValue = today_current_time;
                            view.btnBeginDate.set("label", month_beginning.format("DD.MM.YYYY"));
                            view.btnEndDate.set("label", today_current_time.format("DD.MM.YYYY"));
                            view.loadDetailContent();
                        };
                        view.monthBtn = bottom_btn4;
                        tr.appendChild(view.monthBtn.domNode);
                        view.monthBtn.startup();
                    } else {
                        view.btnBeginDate.set("label", view_main.btnBeginDate.label);
                        view.btnEndDate.set("label", view_main.btnEndDate.label);
                    }
                };
                /*{
                 "head": "Магазины",
                 "units":[
                 { "id": "Bata1", "short_name": "Bata1", "name": "Магазин  БАТА1" }
                 ,{ "id": "Bata2", "short_name": "Bata2", "name": "Магазин БАТА2" } ]
                 }*/
                view_main.loadMainContent = function () {
                    getJSONData({url: "/mobile", condition: "action=get_units", consoleLog: true}
                            , function (success, result) {                                                              console.log("view_main.loadMainContent getJSONData ", result);
                                if (success) {
                                    view_main.setMainContent(result);
                                } else {//error!!!
                                    view_main.setMainContent({"head": "Нет данных", "units": []});
                                }
                            }
                    );
                };
                view_main.setMainContent = function (maindata) {
                    view_main.first_header_string = maindata.head;
                    view_main.top_heading_main.set("label", view_main.first_header_string);
                    view_main.pickUnitBtn.units_data = maindata.units;                          console.log("maindata.units=", maindata.units);
                    view_main.pickUnitBtn.selected_units = [];
                    view_main.pickUnitBtn.selected_units[0] = view_main.pickUnitBtn.units_data[0];
                    view_main.pickUnitBtn.selected_units[1] = view_main.pickUnitBtn.units_data[1];
                    view_main.pickUnitBtn.selected_units[2] = view_main.pickUnitBtn.units_data[2];
                    view_main.string_units = view_main.pickUnitBtn.selected_units[0].short_name + " | " +
                            view_main.pickUnitBtn.selected_units[1].short_name + " | " +
                            view_main.pickUnitBtn.selected_units[2].short_name;
                    view_main.pickUnitBtn.set("label", view_main.string_units);
                    view_main.setTopButtonsFor(view_main);
                    view_main.setBottomButtonsFor(view_main);
                    view_main.inner_scroll.startup();
                    view_main.startup();
                    if (maindata.mode.indexOf("test") !== -1) {
                        var test_btn = new ToolBarButton({
                            icon: "/icons/exclamation-mark29x29.ico",
                            iconPos: "0,0,29,29",
                            style: "float:right",
                            onClick: function () {
                                view_main.msgBox.innerHTML = maindata.mode;
                                view_main.dialogWin.show();
                            }
                        });
                        view_main.top_heading_main.addChild(test_btn);
                    }
                    if (!view_main.btnBeginDate.label) view_main.todayBtn.onClick();
                    //   view_main.btnBeginDate_dateValue, view_main.btnEndDate_dateValue
                    //          20161001    201610131
                    //  var cashbalance = loadMobileDataFromServer("/mobile?action=get_cashbalance&bdate=" + bdate + "&edate=" + edate + unit_params);
                };
                view_main.loadDetailContent = function () {
                    var view_main_list_items = registry.byId("view_main_list_items");
                    if (view_main_list_items) {
                       view_main_list_items.destroy();
                    }
                    if (view_main.prog) {
                        view_main.prog.destroy()
                    }
                    view_main.prog = new ProgressIndicator({size: 200, center: true});
                    document.getElementById('body').appendChild(view_main.prog.domNode);
                    view_main.prog.start();
                    var bdate = view_main.btnBeginDate_dateValue.format("YYYYMMDD");
                    var edate = view_main.btnEndDate_dateValue.format("YYYYMMDD");
                    var detail = (view_main.detailBtn.get("checked")) ? "&detail" : "";
                    var units_list = view_main.pickUnitBtn.selected_units;
                    var unit_params = null;
                    for (var i in units_list) {
                        var unit_condition = "unit_" + i + "_id=" + units_list[i].id;
                        unit_params = (unit_params === null) ? unit_condition : unit_params+"&" + unit_condition;
                    }                                                                                           console.log("unit_params=",unit_params);
                    getJSONData({
                                url: "/mobile",
                                condition: "action=get_main_data&bdate=" + bdate + "&edate=" + edate + "&"+unit_params + detail,//get_cashbalance
                                consoleLog: true
                            }
                            , function (success, result) {
                                if (success) {                                                                          console.log("view_main.loadDetailContent getJSONData result=", result);
                                    if (result.error) {
                                        view_main.msgBox.innerHTML = "Нет данных";                                      console.log("view_main.loadDetailContent getJSONData DATA ERROR! error=", result.error);
                                        view_main.dialogWin.show();
                                    } else view_main.setDetailContent(result);
                                } else {//error!!!
                                    view_main.msgBox.innerHTML = "Нет связи с сервером";
                                    view_main.dialogWin.show();
                                }
                                view_main.prog.stop();
                            }
                    );
                };
                view_main.setDetailContent = function (balance_data) {
                    var view_main_list_items = new roundRectList({
                        style: "position:relative",
                        "id": "view_main_list_items"
                    });
                    view_main.inner_scroll.scrollTo({x:0, y:-5});
                    view_main.inner_scroll.addChild(view_main_list_items);
                    view_main_list_items.startup();
                    var data = balance_data.items;                                                       console.log("data=", data);
                    for (var i in data) {
                        var dataItem = data[i], listItemIdPrefix = "mainListItem_";
                        var list_item = registry.byId(listItemIdPrefix + dataItem.id);
                        var string_value = numeral(dataItem.value).format('0,0');
                        list_item = new ListItem({
                            id: listItemIdPrefix + dataItem.id,
                            label: dataItem.label,
                            data_unit_id: dataItem.unit_id,
                            rightText: string_value,
                            moveTo: "view_" + dataItem.id,
                            transition: "none"
                        });
                        if (dataItem.icon) {
                            list_item.set("icon", dataItem.icon);
                            list_item.set("iconPos", "0,0,29,29");
                        }
                        if (dataItem.style) {
                            list_item.set("style", dataItem.style);
                        }
                        if (!dataItem.style) {
                            list_item.set("style", "background-color:white")
                        }
                        if (dataItem.url) {
                            list_item.url = dataItem.url;
                        }
                        if (dataItem.action) {
                            list_item.actionValue = dataItem.action;
                            list_item.onClick = function () {
                                var view = view_main.showDetailView(view_main.first_header_string + " - " + this.label, this.moveTo, this.url, this.actionValue, this.data_unit_id);
                            }
                        }
//                        if(list_item.data_unit_id){
//                            list_item.onClick = function () {
//                                var view = view_main.showDetailView(view_main.first_header_string + " - " + this.label, this.moveTo, this.url, this.actionValue );
//                            }
//                        }

//                        if(dataItem.unit_id){
//                            list_item.set({data_unit_id : dataItem.unit_id})
//                        }
//                        if (list_item.actionValue==undefined && list_item.data_unit_id==undefined) {
//                            list_item.set({
//                                preventTouch: true,
//                                noArrow: true
//                            });
                    //    }
                        view_main_list_items.addChild(list_item);
                        list_item.startup();
                    }
                };
                view_main.showDetailView = function (heading_label, id, url, actionValue, unit_id) {
                    var view = registry.byId(id);
                    if (!view) {
                        view = new View({id: id});
                        document.getElementById('body').appendChild(view.domNode);

                        var top_heading = new Heading({
                            label: heading_label,
                            back: "Назад",
                            moveTo: "view_main",
                            transition: "none",
                            onClick: function () {
                                view_main.loadDetailContent()
                            }
                        });
                        view.inner_scroll = new ScrollableView({});
                        document.getElementById('body').appendChild(view.inner_scroll.domNode);
                        view.url = url;
                        view.addChild(top_heading, 0);
                        setPickBtnFor(view,unit_id);
                        view.addChild(view.inner_scroll);
                        view_main.setTopButtonsFor(view);
                        view_main.setBottomButtonsFor(view);
                        view.inner_scroll.startup();
                        view.startup();

                        view.loadDetailContent = function () {             console.log("loadDetailContent");
                            if (view.list_items) {
                                view.list_items.destroy();
                            }
                            if (view.prog) {
                                view.prog.destroy()
                            }
                            view.prog = new ProgressIndicator({size: 200, center: true, removeOnStop: true});
                            document.getElementById('body').appendChild(view.prog.domNode);
                            view.prog.start();
                            var bdate = view.btnBeginDate_dateValue.format("YYYYMMDD");
                            var edate = view.btnEndDate_dateValue.format("YYYYMMDD");

                            var unit_params = null;
                            if (unit_id===undefined){
                                var units_list = view.pickUnitBtn.selected_units;
                                for (var i in units_list) {
                                    var unit_condition = "unit_" + i + "_id=" + units_list[i].id;
                                    unit_params = (unit_params === null) ? unit_condition : unit_params+"&" + unit_condition;
                                }                                                                                                   console.log("unit_params=",unit_params);
                            } else
                                unit_params = "unit_id=" + unit_id;
                            getJSONData({
                                        //  url: "mobile/cashin_sum.json"
                                        url: view.url,
                                        condition: "action=" + actionValue + "&bdate=" + bdate + "&edate=" + edate + "&"+unit_params,
                                        consoleLog: true
                                    }
                                    , function (success, result) {
                                        if (success) {
                                            if (result.error) {
                                                view_main.msgBox.innerHTML = "Нет данных";                              console.log("view.loadDetailContent getJSONData DATA ERROR! error=", result.error);
                                                view_main.dialogWin.show();
                                            } else view.setDetailContent(result.items);
                                        } else {
                                            view_main.msgBox.innerHTML = "Нет связи с сервером";
                                            view_main.dialogWin.show();
                                        }
                                        view.prog.stop();
                                    }
                            );
                        }

                    } else {
                        setPickBtnFor(view,unit_id);
                        view_main.setTopButtonsFor(view);
                    }
                    view.setDetailContent = function (data) {
                        view.list_items = new roundRectList({"id": "list" + this.id});
                        this.inner_scroll.addChild(view.list_items);
                        view.inner_scroll.scrollTo({x:0, y:-5});
                        /*
                         [
                         {"label":"","value":"125"},
                         {"label":"","value":"340"},
                         {"label":"","value":"600"},
                         {"label":"","value":"-340"},
                         {"label":"","value":"1500"}
                         ]
                         */
                        for (var i in data) {
                            var dataItem = data[i];
                            var item = new ListItem({
                                style: "background-color:white",
                                label: dataItem.label,
                                rightText: numeral(dataItem.value).format('0,0')
                            });
                            view.list_items.addChild(item);
                        }
                        view.list_items.startup();
                    };
                    view.loadDetailContent();
                    return view;
                };
                var showCalendarView = function (btn, heading, view) {
                    var date_picker = registry.byId("date_picker");
                    var accept_btn = registry.byId("accept_btn");
                    var calendar_heading = registry.byId("calendar_heading");
                    var calendar_view = registry.byId("calendar_view");
                    if (!calendar_view) {
                        var view_div = document.createElement("div");
                        view_div.setAttribute("id", "calendar_view");
                        document.getElementById("body").appendChild(view_div);
                        calendar_view = new View({id: "calendar_view"}, "calendar_view");
                        calendar_heading = new Heading({
                            transition: "none",
                            id: "calendar_heading",
                            back: "Назад",
                            moveTo: view.id
                        });
                        calendar_view.addChild(calendar_heading);
                        date_picker = new CalendarLite({
                            lang: 'ru',
                            id: "date_picker"
                        }, "date_picker");
                        date_picker.startup();
                        calendar_view.addChild(date_picker);
                        var accept_heading = new Heading(
                        );
                        accept_btn = new ToolBarButton({
                            style: "width:75px;align",
                            id: "accept_btn", label: "Выбрать",
                            transition: "none"
                        });
                        accept_heading.addChild(accept_btn);
                        calendar_view.addChild(accept_heading);
                        accept_heading.startup();
                        calendar_view.startup();
                    }
                    var string_date = "" + btn.get("label").substring(6, 10) + "-" + btn.get("label").substring(3, 5) + "-" + btn.get("label").substring(0, 2);
                    date_picker.set("value", string_date);
                    calendar_heading.set("label", heading);
                    calendar_heading.set("moveTo", view.id);
                    accept_btn.set("moveTo", view.id);
                    accept_btn.onClick = function () {
                        var selected_date = moment(date_picker.get("value"));
                        btn.set("label", selected_date.format("DD.MM.YYYY"));
                        if (btn.id == "date_first_" + view.id) {
                            view.btnBeginDate_dateValue = selected_date;
                        }
                        if (btn.id == "date_last_" + view.id) {
                            view.btnEndDate_dateValue = selected_date;
                        }
//                        var date1_milsec = new Date(view.btnBeginDate_dateValue).getTime();
//                        var date2_milsec = new Date(view.btnEndDate_dateValue).getTime();
//                        if ((date2_milsec - date1_milsec) < 0) {
//                          var temp=view.btnBeginDate_dateValue;
//                            view.btnBeginDate_dateValue=view.btnEndDate_dateValue;
//                            view.btnEndDate_dateValue=temp;
//                        }
                        view.loadDetailContent();
                    }
                };
                var showPickUnitView = function (btn, view) {                                                           console.log("btn.units_data=", btn.units_data, "btn.selected_units=", btn.selected_units);
                    var pick_view = registry.byId("pick_unit_view");
                    if (!pick_view) {
                        pick_view = new View({id: "pick_unit_view"});
                        pick_view.top_heading = new Heading({
                            transition: "none",
                            label: "Выберите филиал",
                            back: "Назад"
                        });
                        document.getElementById("body").appendChild(pick_view.domNode);
                        pick_view.top_heading.startup();
                        pick_view.addChild(pick_view.top_heading, 0);
                    }
                    pick_view.top_heading.set("moveTo", view.id);
                    pick_view.listUnitButtons = [];
                    var data;

                    if (pick_view.list_of_units) pick_view.list_of_units.destroy();
                    pick_view.list_of_units = new roundRectList({
                        style: "background-color:white",
                        "id": view.id + "list_of_units"
                    });
                    pick_view.addChild(pick_view.list_of_units, 1);
                    pick_view.list_of_units.startup();
                    data = btn.units_data;
                    for (var i in data) {
                        var dataItem = data[i];
                        var tooggleBtn = new ToggleButton({
                            label: dataItem.short_name,
                            style: "font-size: 1em; width:100px; text-align:left"
                        });
                        tooggleBtn.unit_id = dataItem.id;                                                               console.log("tooggleBtn.unit_id=",tooggleBtn.unit_id);
                        var item = new ListItem({
                            preventTouch: true,
                            innerHTML: " " + dataItem.name,
                            style: "background-color:white"
                        });                                                                                              console.log("631  btn.selected_units.length=", btn.selected_units);
                        for (var s=0; s<btn.selected_units.length; s++) {
                            if (tooggleBtn.unit_id == btn.selected_units[s].id) tooggleBtn.set("checked", true);         console.log("tooggleBtn.unit_id s=",tooggleBtn.unit_id,"btn.selected_units[s].id=", btn.selected_units[s].id  );
                        }
                        pick_view.list_of_units.addChild(item);
                        pick_view.listUnitButtons[i] = tooggleBtn;
                        item.addChild(tooggleBtn, 0);
                    }
                    if (!pick_view.accept_heading) {
                        pick_view.accept_heading = new Heading({id: view.id + "accept_heading"});
                    }
                    if (!pick_view.confirmBtn) {
                        pick_view.confirmBtn = new ToolBarButton({
                            transition: "none",
                            id: view.id + "confirmBtn",
                            label: "Выбрать"
                        });
                        pick_view.addChild(pick_view.accept_heading);
                        pick_view.accept_heading.addChild(pick_view.confirmBtn, 2);
                        pick_view.accept_heading.startup();
                        pick_view.startup();
                    }
                    pick_view.confirmBtn.parentBtn = btn;
                    pick_view.confirmBtn.onClick = function () {
                        var selected_units = [], string_units;
                        var d = 0;
                        for (var j = 0; j < pick_view.listUnitButtons.length; j++) {
                            var dataItem = data[j];
                            if (pick_view.listUnitButtons[j].get("checked") == true) {
                                string_units = (!string_units) ? dataItem.short_name : string_units + " | " + dataItem.short_name;
                                selected_units[d] = dataItem;
                                d++;
                            }
                        }
                        if (selected_units.length > 0) {
                            this.parentBtn.selected_units = selected_units;
                            this.parentBtn.set("label", string_units);
                            pick_view.confirmBtn.set("moveTo", view.id);
                            view.loadDetailContent();
                        } else
                            pick_view.confirmBtn.set("moveTo", null);                                                   console.log("this.parentBtn.selected_units=", this.parentBtn.selected_units, "UNITS_data=", this.parentBtn.units_data);
                    };
                };
                var setPickBtnFor = function (view,unit_id ) {
                    if (!view.pickUnitBtnHeading) {
                        view.pickUnitBtnHeading = new Heading();
                        var icon_btn = new ToolBarButton({
                            preventTouch: true,
                            clickable: false,
                            icon: "/icons/hearts29x29.ico",
                            iconPos: "0,0,29,29"
                        });
                        view.pickUnitBtnHeading.addChild(icon_btn);
                        view.addChild(view.pickUnitBtnHeading);
                        view.pickUnitBtnHeading.startup();
                    }
                    if (!view.pickUnitBtn) {
                        view.pickUnitBtn = new ToolBarButton({
                            style: "width:" + v + "px; font-size:14px; align: center",
                            transition: "none",
                            moveTo: "pick_unit_view",
                            onClick: function () {
                                showPickUnitView(this, view);
                            }
                        });
                        view.pickUnitBtn.selected_units=[];
                    }
                   view.pickUnitBtn.units_data = view_main.pickUnitBtn.units_data;
                   if(unit_id===undefined) {
                       view.pickUnitBtn.selected_units = view_main.pickUnitBtn.selected_units;
                       view.pickUnitBtn.set("label", view_main.pickUnitBtn.label);
                   }else{
                       for(var u in view_main.pickUnitBtn.units_data){
                           var unit_data=view_main.pickUnitBtn.units_data[u];
                           if(unit_id==unit_data.id){
                               view.pickUnitBtn.selected_units[0]=unit_data;
                               view.pickUnitBtn.set("label", unit_data.short_name);
                           }
                       }
                   }
                    view.pickUnitBtnHeading.addChild(view.pickUnitBtn);
                    window.onresize = function () {
                        v = window.innerWidth - 90;
                        view.pickUnitBtn.set("style", "width:" + v + "px; font-size:14px; align: center");
                    };
                };
                view_main.loadMainContent();
            });
</script>
</html>